rules_version = '2';

function isAdmin() {
  return request.auth != null &&
    (
      request.auth.token.admin == true ||
      request.auth.token.role == 'admin' ||
      request.auth.token.role == 'super_admin'
    );
}

function notBanned() {
  return request.auth != null &&
    get(/databases/$(database)/documents/users/$(request.auth.uid)).data.banned != true;
}

service cloud.firestore {
  match /databases/{database}/documents {

    // Admin full access
    match /{document=**} {
      allow read, write: if isAdmin();
    }

    // USERS: users/{userId}
    match /users/{userId} {
      // Cho phép mọi người đọc hồ sơ cơ bản
      allow read: if true;

      // Chỉ chính chủ mới được tạo/cập nhật/xoá hồ sơ, và không bị khóa
      allow write: if request.auth != null
                  && request.auth.uid == userId
                  && notBanned();
      
      // FCM TOKENS: users/{userId}/fcmTokens/{tokenId}
      match /fcmTokens/{tokenId} {
        // User chỉ đọc/ghi FCM tokens của chính mình, và không bị khóa
        allow read, write: if request.auth != null
                           && request.auth.uid == userId
                           && notBanned();
      }
    }

    // ROOMS (TIN ĐĂNG PHÒNG TRỌ): rooms/{roomId}
    match /rooms/{roomId} {
      // Ai cũng đọc được tin phòng trọ
      allow read: if true;

      // Tạo mới: User đã đăng nhập, không bị khóa, có thể tạo room
      allow create: if request.auth != null && notBanned();
      
      // Cập nhật/Xóa: Chỉ ownerId (người đăng tin), không bị khóa, mới được sửa/xóa
      allow update, delete: if request.auth != null
                           && resource.data.ownerId == request.auth.uid
                           && notBanned();
    }

    // FAVORITES: favorites/{favoriteId}
    match /favorites/{favoriteId} {
      // Đọc: User chỉ đọc được favorites của chính mình, và không bị khóa
      allow read: if request.auth != null
                  && request.auth.uid == resource.data.userId
                  && notBanned();
      
      // Tạo mới: User chỉ tạo favorite với userId của chính mình, và không bị khóa
      allow create: if request.auth != null
                    && request.auth.uid == request.resource.data.userId
                    && notBanned();
      
      // Cập nhật/Xóa: User chỉ sửa/xóa favorites của chính mình, và không bị khóa
      allow update, delete: if request.auth != null
                             && request.auth.uid == resource.data.userId
                             && notBanned();
    }

    // LỊCH SỬ XEM: viewHistory/{historyId}
    match /viewHistory/{historyId} {
      allow read: if request.auth != null
                  && request.auth.uid == resource.data.userId
                  && notBanned();
      allow create: if request.auth != null
                    && request.auth.uid == request.resource.data.userId
                    && notBanned();
      allow update, delete: if request.auth != null
                             && request.auth.uid == resource.data.userId
                             && notBanned();
    }

    // THÔNG BÁO: notifications/{notiId}
    match /notifications/{notiId} {
      // Đọc: User chỉ đọc được notifications của chính mình và không bị khóa
      allow get: if request.auth != null
                 && resource.data.userId == request.auth.uid
                 && notBanned();
      
      // List/Query: Cho phép query nhưng chỉ trả về notifications của user hiện tại
      allow list: if request.auth != null && notBanned();
      
      // Tạo mới: Cho phép user tạo notification cho người khác (ví dụ: notification về tin nhắn mới)
      // Nhưng chỉ cho phép nếu có type hợp lệ (new_message, room_approved, etc.), và không bị khóa
      allow create: if request.auth != null
                    && notBanned()
                    && request.resource.data.type is string
                    && request.resource.data.userId is string
                    && (request.resource.data.type == 'new_message'
                         || request.resource.data.type == 'room_approved'
                         || request.resource.data.type == 'room_rejected'
                         || request.resource.data.type == 'room_price_changed');
      
      // Cập nhật/Xóa: User chỉ sửa/xóa notifications của chính mình và không bị khóa
      allow update, delete: if request.auth != null
                             && resource.data.userId == request.auth.uid
                             && notBanned();
    }

    // CONVERSATIONS: conversations/{convId}
    match /conversations/{convId} {
      // Đọc: User chỉ đọc được conversation mà họ là participant
      allow read: if request.auth != null
                  && resource.data.participantIds.hasAny([request.auth.uid]);
      
      // Tạo mới: User đã đăng nhập có thể tạo conversation nếu họ là participant
      allow create: if request.auth != null
                    && request.resource.data.participantIds.hasAny([request.auth.uid]);
      
      // Cập nhật: User chỉ update conversation mà họ là participant
      // Cho phép update các field như unreadCount, lastMessage, lastMessageAt, otherUserName, otherUserAvatar
      // Nhưng không cho phép thay đổi participantIds
      allow update: if request.auth != null
                    && resource.data.participantIds.hasAny([request.auth.uid])
                    && request.resource.data.participantIds == resource.data.participantIds;
      
      // Xóa: User chỉ xóa conversation mà họ là participant
      allow delete: if request.auth != null
                    && resource.data.participantIds.hasAny([request.auth.uid]);
      
      // MESSAGES: conversations/{convId}/messages/{msgId}
      match /messages/{msgId} {
        // Đọc: User chỉ đọc được messages trong conversation mà họ là participant
        allow read: if request.auth != null
                    && get(/databases/$(database)/documents/conversations/$(convId)).data.participantIds.hasAny([request.auth.uid]);
        
        // Tạo mới: User chỉ gửi message trong conversation mà họ là participant
        allow create: if request.auth != null
                      && request.resource.data.senderId == request.auth.uid
                      && get(/databases/$(database)/documents/conversations/$(convId)).data.participantIds.hasAny([request.auth.uid]);
        
        // Cập nhật: User có thể update message của chính mình
        // Hoặc update isRead cho messages của người khác (để đánh dấu đã đọc)
        allow update: if request.auth != null
                      && get(/databases/$(database)/documents/conversations/$(convId)).data.participantIds.hasAny([request.auth.uid])
                      && (
                          // Update message của chính mình
                          resource.data.senderId == request.auth.uid
                          ||
                          // Hoặc chỉ update isRead và readAt cho messages của người khác (đánh dấu đã đọc)
                          (resource.data.senderId != request.auth.uid
                           && request.resource.data.diff(resource.data).affectedKeys().hasOnly(['isRead', 'readAt']))
                      );
        
        // Xóa: User chỉ xóa message của chính mình
        allow delete: if request.auth != null
                      && resource.data.senderId == request.auth.uid;
      }
    }

  }
}
