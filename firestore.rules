rules_version = '2';

function isAdmin() {
  return request.auth != null &&
    (
      request.auth.token.admin == true ||
      request.auth.token.role == 'admin' ||
      request.auth.token.role == 'super_admin'
    );
}

function notBanned() {
  return request.auth != null &&
    (
      // Nếu user doc chưa tồn tại thì coi như không bị khóa để tránh lỗi null
      !exists(/databases/$(database)/documents/users/$(request.auth.uid)) ||
      get(/databases/$(database)/documents/users/$(request.auth.uid)).data.banned != true
    );
}

service cloud.firestore {
  match /databases/{database}/documents {

    // Admin full access
    match /{document=**} {
      allow read, write: if isAdmin();
    }

    // USERS: không check banned để tránh lỗi presence/FCM
    match /users/{userId} {
      allow read: if true;
      allow write: if request.auth != null && request.auth.uid == userId;
      
      // FCM TOKENS: users/{userId}/fcmTokens/{tokenId}
      match /fcmTokens/{tokenId} {
        allow read, write: if request.auth != null && request.auth.uid == userId;
      }
    }

    // ROOMS (TIN ĐĂNG PHÒNG TRỌ): rooms/{roomId}
    match /rooms/{roomId} {
      // Ai cũng đọc được tin phòng trọ
      allow read: if true;

      // Tạo mới: User đã đăng nhập
      allow create: if request.auth != null;
      
      // Cập nhật/Xóa: Chỉ ownerId (người đăng tin) mới được sửa/xóa
      allow update, delete: if request.auth != null
                           && resource.data.ownerId == request.auth.uid;
    }

    // FAVORITES: favorites/{favoriteId}
    match /favorites/{favoriteId} {
      allow read, list: if request.auth != null
                  && request.auth.uid == resource.data.userId;
      allow create: if request.auth != null
                    && request.auth.uid == request.resource.data.userId;
      allow update, delete: if request.auth != null
                             && request.auth.uid == resource.data.userId;
    }

    // LỊCH SỬ XEM: viewHistory/{historyId}
    match /viewHistory/{historyId} {
      allow read, list: if request.auth != null
                  && resource.data.userId == request.auth.uid;
      allow create: if request.auth != null
                    && request.auth.uid == request.resource.data.userId;
      allow update, delete: if request.auth != null
                             && request.auth.uid == resource.data.userId;
    }

    // THÔNG BÁO: notifications/{notiId}
    match /notifications/{notiId} {
      allow read, list: if request.auth != null
                 && (
                      resource.data.userId == request.auth.uid
                      || resource.data.data.userId == request.auth.uid
                    );
      allow create: if request.auth != null
                    && request.resource.data.type is string
                    && (
                        request.resource.data.userId is string
                        || request.resource.data.data.userId is string
                       )
                    && (request.resource.data.type == 'new_message'
                         || request.resource.data.type == 'room_approved'
                         || request.resource.data.type == 'room_rejected'
                         || request.resource.data.type == 'room_price_changed');
      allow update, delete: if request.auth != null
                             && (
                                  resource.data.userId == request.auth.uid
                                  || resource.data.data.userId == request.auth.uid
                                );
    }

    // CONVERSATIONS: conversations/{convId}
    match /conversations/{convId} {
      allow read, list: if request.auth != null
                  && resource.data.participantIds.hasAny([request.auth.uid]);
      allow create: if request.auth != null
                    && request.resource.data.participantIds.hasAny([request.auth.uid]);
      allow update: if request.auth != null
                    && resource.data.participantIds.hasAny([request.auth.uid])
                    && request.resource.data.participantIds == resource.data.participantIds;
      allow delete: if request.auth != null
                    && resource.data.participantIds.hasAny([request.auth.uid]);
      
      // MESSAGES: conversations/{convId}/messages/{msgId}
      match /messages/{msgId} {
        allow read, list: if request.auth != null
                    && get(/databases/$(database)/documents/conversations/$(convId)).data.participantIds.hasAny([request.auth.uid]);
        allow create: if request.auth != null
                      && request.resource.data.senderId == request.auth.uid
                      && get(/databases/$(database)/documents/conversations/$(convId)).data.participantIds.hasAny([request.auth.uid]);
        allow update: if request.auth != null
                      && get(/databases/$(database)/documents/conversations/$(convId)).data.participantIds.hasAny([request.auth.uid])
                      && (
                          resource.data.senderId == request.auth.uid
                          || (resource.data.senderId != request.auth.uid
                              && request.resource.data.diff(resource.data).affectedKeys().hasOnly(['isRead', 'readAt']))
                      );
        allow delete: if request.auth != null
                      && resource.data.senderId == request.auth.uid;
      }
    }

  }
}
